<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slideshower 2001 | Toyota of Coconut Creek</title>
    <link rel="icon" href="https://res.cloudinary.com/dgcdcqjrz/image/upload/v1767624172/TOCC_BUG_-_COLOR_cag4ud.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600;700&family=Montserrat:wght@400;500;600;700;800&family=Oswald:wght@400;500;600;700&family=Barlow+Condensed:wght@400;500;600;700;800&family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;700&family=Teko:wght@400;500;600;700&family=Anton&display=swap" rel="stylesheet">
    <style>
        @font-face { font-family: 'Toyota Type'; src: url('https://res.cloudinary.com/dgcdcqjrz/raw/upload/v1769631833/ToyotaType-Light_k0vwbf.ttf') format('truetype'); font-weight: 300; }
        @font-face { font-family: 'Toyota Type'; src: url('https://res.cloudinary.com/dgcdcqjrz/raw/upload/v1769631833/ToyotaType-Book_jxqcqz.ttf') format('truetype'); font-weight: 400; }
        @font-face { font-family: 'Toyota Type'; src: url('https://res.cloudinary.com/dgcdcqjrz/raw/upload/v1769631833/ToyotaType-Regular_x0fblq.ttf') format('truetype'); font-weight: 500; }
        @font-face { font-family: 'Toyota Type'; src: url('https://res.cloudinary.com/dgcdcqjrz/raw/upload/v1769631833/ToyotaType-Semibold_xgfplw.ttf') format('truetype'); font-weight: 600; }
        @font-face { font-family: 'Toyota Type'; src: url('https://res.cloudinary.com/dgcdcqjrz/raw/upload/v1769631834/ToyotaType-Bold_hehwid.ttf') format('truetype'); font-weight: 700; }
        @font-face { font-family: 'Toyota Type'; src: url('https://res.cloudinary.com/dgcdcqjrz/raw/upload/v1769631833/ToyotaType-Black_yxu4fl.ttf') format('truetype'); font-weight: 900; }
    </style>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        const firebaseConfig = { apiKey: "AIzaSyB4yBhV6xHoDFOlX9e-OACAsI9i2QukmfA", authDomain: "slideshower-2001.firebaseapp.com", projectId: "slideshower-2001", storageBucket: "slideshower-2001.firebasestorage.app", messagingSenderId: "492074566821", appId: "1:492074566821:web:b440b35b91327eaf91794c" };
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.fbHelpers = { collection, doc, setDoc, getDoc, getDocs, deleteDoc };
        window.firebaseReady = true;
    </script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --bg: #fff; --bg2: #f8f9fa; --bg3: #f1f3f5; --border: #dadce0; --text: #202124; --text2: #5f6368; --text3: #80868b; --accent: #EB0A1E; --accent-bg: #fce8e6; --blue: #1a73e8; --green: #34a853; --orange: #ea8600; --red: #d93025; --radius: 4px; --font: 'Roboto', sans-serif; }
        html, body { font-family: var(--font); background: var(--bg2); color: var(--text); font-size: 14px; height: 100%; overflow: hidden; }
        .app { display: grid; grid-template-columns: 200px 1fr 240px; grid-template-rows: 48px 1fr; height: 100vh; }
        .header { grid-column: 1/-1; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 16px; gap: 12px; }
        .logo { display: flex; align-items: center; gap: 8px; font-weight: 500; font-size: 15px; }
        .logo img { height: 26px; }
        .logo b { color: var(--accent); font-size: 11px; background: var(--accent-bg); padding: 2px 6px; border-radius: 3px; margin-left: 4px; }
        .spacer { flex: 1; }
        .sync { font-size: 12px; color: var(--green); display: flex; align-items: center; gap: 4px; }
        .sync::before { content: ''; width: 6px; height: 6px; background: var(--green); border-radius: 50%; }
        .btn { height: 32px; padding: 0 14px; border: 1px solid var(--border); background: var(--bg); border-radius: var(--radius); font-family: var(--font); font-size: 13px; font-weight: 500; color: var(--text2); cursor: pointer; display: inline-flex; align-items: center; gap: 6px; }
        .btn:hover { background: var(--bg3); }
        .btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; }
        .btn-primary:hover { background: #c4081a; }
        .btn-sm { height: 28px; padding: 0 10px; font-size: 12px; }
        .btn-danger { color: var(--red); }
        .sidebar { background: var(--bg); border-right: 1px solid var(--border); overflow-y: auto; padding: 8px; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: var(--radius); cursor: pointer; font-size: 13px; font-weight: 500; color: var(--text2); margin-bottom: 2px; }
        .nav-item:hover { background: var(--bg3); }
        .nav-item.active { background: var(--accent-bg); color: var(--accent); }
        .nav-badge { margin-left: auto; background: var(--accent); color: #fff; font-size: 11px; padding: 1px 6px; border-radius: 10px; }
        .section-title { font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text3); padding: 14px 12px 6px; }
        .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; padding: 0 4px; }
        .theme-card { padding: 4px; border: 2px solid transparent; border-radius: var(--radius); cursor: pointer; }
        .theme-card:hover { border-color: var(--border); }
        .theme-card.selected { border-color: var(--accent); }
        .theme-preview { height: 24px; border-radius: 2px; margin-bottom: 2px; }
        .theme-name { font-size: 10px; font-weight: 500; text-align: center; color: var(--text2); }
        .logo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; padding: 0 4px; }
        .logo-option { aspect-ratio: 3/2; border: 2px solid var(--border); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 4px; background: #f8f8f8; }
        .logo-option:hover { border-color: var(--text3); }
        .logo-option.selected { border-color: var(--accent); }
        .logo-option.dark-bg { background: #1a1a1a; }
        .logo-option img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 4px 8px; font-size: 12px; color: var(--text2); }
        .toggle { width: 32px; height: 16px; background: var(--border); border-radius: 8px; cursor: pointer; position: relative; }
        .toggle.active { background: var(--accent); }
        .toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 12px; height: 12px; background: #fff; border-radius: 50%; transition: transform 0.15s; }
        .toggle.active::after { transform: translateX(16px); }
        .main { background: #202124; display: flex; flex-direction: column; overflow: hidden; }
        .toolbar { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #292a2d; }
        .toolbar .btn { background: #3c4043; border-color: #5f6368; color: #e8eaed; }
        .toolbar .btn:hover { background: #4a4d51; }
        .zoom-label { font-size: 12px; color: #9aa0a6; min-width: 40px; text-align: center; }
        .canvas-area { flex: 1; display: flex; align-items: center; justify-content: center; padding: 16px; overflow: hidden; }
        .canvas-wrap { background: #000; box-shadow: 0 4px 20px rgba(0,0,0,0.5); border-radius: 4px; overflow: hidden; }
        .canvas-wrap canvas { display: block; }
        .canvas-nav { display: flex; align-items: center; justify-content: center; gap: 16px; padding: 10px; background: #292a2d; }
        .canvas-nav .btn { background: transparent; border-color: #5f6368; color: #e8eaed; }
        .nav-info { text-align: center; color: #e8eaed; min-width: 180px; }
        .nav-info strong { display: block; font-size: 13px; }
        .nav-info span { font-size: 11px; color: #9aa0a6; }
        .panel { background: var(--bg); border-left: 1px solid var(--border); overflow-y: auto; padding: 12px; }
        .panel-title { font-size: 11px; font-weight: 500; text-transform: uppercase; color: var(--text3); margin: 12px 0 8px; }
        .panel-title:first-child { margin-top: 0; }
        .form-group { margin-bottom: 8px; }
        .form-label { display: block; font-size: 11px; font-weight: 500; color: var(--text2); margin-bottom: 3px; }
        .form-input, .form-select { width: 100%; height: 30px; padding: 0 8px; border: 1px solid var(--border); background: var(--bg); border-radius: var(--radius); font-family: var(--font); font-size: 12px; color: var(--text); }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--blue); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .form-textarea { height: auto; min-height: 50px; padding: 6px 8px; resize: vertical; }
        .view { display: none; flex-direction: column; height: 100%; overflow: hidden; }
        .view.active { display: flex; }
        .view-header { display: flex; align-items: center; gap: 10px; padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--bg); }
        .view-header h2 { font-size: 16px; font-weight: 400; }
        .view-body { flex: 1; overflow: auto; padding: 16px; background: var(--bg); }
        .calc-bar { display: flex; align-items: center; gap: 16px; padding: 10px 14px; background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 12px; font-size: 12px; }
        .calc-bar strong { font-size: 13px; }
        .calc-bar label { color: var(--text2); margin-right: 4px; }
        .calc-bar input, .calc-bar select { width: 65px; height: 26px; font-size: 12px; }
        .filters { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
        .filters .form-input { width: 150px; height: 30px; }
        .filters .form-select { width: auto; min-width: 90px; height: 30px; }
        .filter-check { display: flex; align-items: center; gap: 4px; font-size: 12px; color: var(--text2); }
        .filter-count { font-size: 12px; color: var(--text3); }
        .table-wrap { border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 8px 10px; font-size: 11px; font-weight: 500; text-transform: uppercase; color: var(--text3); background: var(--bg2); border-bottom: 1px solid var(--border); position: sticky; top: 0; }
        th.sortable { cursor: pointer; }
        th.sortable:hover { color: var(--text); }
        td { padding: 8px 10px; border-bottom: 1px solid var(--border); font-size: 12px; }
        tr:hover { background: var(--bg3); }
        tr.selected { background: var(--accent-bg); }
        .thumb { width: 72px; height: 54px; border-radius: 3px; object-fit: cover; background: var(--bg2); }
        .v-name { font-weight: 500; }
        .v-trim { font-size: 11px; color: var(--text3); }
        .days-badge { display: inline-block; padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: 500; background: var(--bg2); }
        .days-badge.warn { background: #fef7e0; color: var(--orange); }
        .days-badge.danger { background: #fce8e6; color: var(--red); }
        .inv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
        .inv-card { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        .inv-card:hover { box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .inv-card-img { width: 100%; height: 110px; object-fit: cover; background: var(--bg2); }
        .inv-card-body { padding: 10px; }
        .inv-card-title { font-weight: 500; font-size: 12px; }
        .inv-card-sub { font-size: 11px; color: var(--text3); margin: 2px 0 6px; }
        .inv-card-price { font-weight: 700; font-size: 14px; color: var(--accent); }
        .inv-card-days { margin-top: 4px; }
        .inv-card-actions { display: flex; gap: 4px; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; }
        .settings-card { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; }
        .settings-card h3 { font-size: 13px; font-weight: 500; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg); border-radius: 8px; width: 90%; max-width: 440px; max-height: 90vh; overflow: hidden; }
        .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid var(--border); }
        .modal-header h3 { font-size: 15px; font-weight: 500; }
        .modal-close { width: 28px; height: 28px; border: none; background: none; cursor: pointer; font-size: 18px; color: var(--text3); border-radius: var(--radius); }
        .modal-close:hover { background: var(--bg3); }
        .modal-body { padding: 16px; max-height: 60vh; overflow-y: auto; }
        .modal-footer { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 8px; }
        .toast-wrap { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1100; }
        .toast { background: #323232; color: #fff; padding: 10px 20px; border-radius: var(--radius); font-size: 13px; }
        .drop-zone { border: 2px dashed var(--border); border-radius: var(--radius); padding: 28px; text-align: center; cursor: pointer; }
        .drop-zone:hover { border-color: var(--blue); background: rgba(26,115,232,0.04); }
        .progress { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--accent); transition: width 0.3s; }
        .recording { position: fixed; top: 56px; right: 16px; background: var(--red); color: #fff; padding: 6px 12px; border-radius: var(--radius); font-size: 11px; display: none; }
        .recording.active { display: block; animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }
        .empty { text-align: center; padding: 40px; color: var(--text3); }
    </style>
</head>
<body>
<div class="app">
    <header class="header">
        <div class="logo"><img src="https://res.cloudinary.com/dgcdcqjrz/image/upload/v1767624172/TOCC_BUG_-_COLOR_cag4ud.png">Slideshower<b>2001</b></div>
        <div class="spacer"></div>
        <div class="sync">Synced</div>
        <button class="btn" onclick="showModal('importModal')">Import</button>
        <button class="btn" onclick="exportProject()">Export</button>
        <button class="btn" onclick="previewSlideshow()">Preview</button>
        <button class="btn btn-primary" onclick="generateVideo()">Generate Video</button>
    </header>
    <aside class="sidebar">
        <div class="nav-item active" data-view="feed" onclick="switchView('feed')">Feed</div>
        <div class="nav-item" data-view="inventory" onclick="switchView('inventory')">Inventory<span class="nav-badge" id="invBadge">0</span></div>
        <div class="nav-item" data-view="design" onclick="switchView('design')">Design</div>
        <div class="nav-item" data-view="settings" onclick="switchView('settings')">Settings</div>
        <div class="section-title">Theme</div>
        <div class="theme-grid" id="themeGrid"></div>
        <div class="section-title">Logo</div>
        <div class="logo-grid" id="logoGrid"></div>
        <div class="form-group" style="padding:6px 8px"><label class="form-label">Size</label><input type="range" id="logoSize" min="60" max="160" value="108" oninput="updatePreview()" style="width:100%"></div>
        <div class="section-title">Show/Hide</div>
        <div class="toggle-row"><span>Badge</span><div class="toggle active" id="showBadge" onclick="toggleVis(this)"></div></div>
        <div class="toggle-row"><span>Stock</span><div class="toggle active" id="showStock" onclick="toggleVis(this)"></div></div>
        <div class="toggle-row"><span>Year</span><div class="toggle active" id="showYear" onclick="toggleVis(this)"></div></div>
        <div class="toggle-row"><span>Trim</span><div class="toggle active" id="showTrim" onclick="toggleVis(this)"></div></div>
        <div class="toggle-row"><span>Price Label</span><div class="toggle active" id="showPriceLabel" onclick="toggleVis(this)"></div></div>
        <div class="toggle-row"><span>Highlight</span><div class="toggle active" id="showHighlight" onclick="toggleVis(this)"></div></div>
        <div class="toggle-row"><span>Payment</span><div class="toggle active" id="showPayment" onclick="toggleVis(this)"></div></div>
        <div class="toggle-row"><span>Down</span><div class="toggle" id="showDown" onclick="toggleVis(this)"></div></div>
        <div class="toggle-row"><span>Disclaimer</span><div class="toggle active" id="showDisclaimer" onclick="toggleVis(this)"></div></div>
    </aside>
    <main class="main">
        <div class="view active" id="feedView" style="background:var(--bg)">
            <div class="view-header"><h2>Vehicle Feed</h2><div class="spacer"></div><button class="btn btn-sm" onclick="showModal('feedUrlModal')">URL</button><button class="btn btn-sm" onclick="document.getElementById('feedFile').click()">Upload</button><input type="file" id="feedFile" accept=".csv,.xlsx,.xls" hidden onchange="loadFeedFile(event)"></div>
            <div class="view-body">
                <div class="calc-bar"><strong>Payment Calc</strong><div><label>Rate%</label><input type="number" class="form-input" id="globalRate" value="6.9" step="0.1"></div><div><label>Term</label><select class="form-select" id="globalTerm"><option value="48">48</option><option value="60">60</option><option value="72" selected>72</option><option value="84">84</option></select></div><div><label>Down$</label><input type="number" class="form-input" id="globalDown" value="3999" step="500"></div></div>
                <div class="filters">
                    <input type="text" class="form-input" id="feedSearch" placeholder="Search..." oninput="renderFeed()">
                    <select class="form-select" id="feedType" onchange="renderFeed()"><option value="all">All Types</option><option value="N">New</option><option value="U">Used</option></select>
                    <select class="form-select" id="feedMake" onchange="onMakeChange()"></select>
                    <select class="form-select" id="feedModel" onchange="renderFeed()"></select>
                    <select class="form-select" id="feedYear" onchange="renderFeed()"></select>
                    <select class="form-select" id="feedDays" onchange="renderFeed()"><option value="all">All Days</option><option value="0-30">0-30</option><option value="31-45">31-45</option><option value="46-60">46-60</option><option value="61+">61+</option></select>
                    <label class="filter-check"><input type="checkbox" id="feedHasImg" checked onchange="renderFeed()">Has Image</label>
                    <div class="spacer"></div>
                    <span class="filter-count" id="feedCount">0</span>
                    <button class="btn btn-sm" onclick="selectAllFeed()">Select All</button>
                    <button class="btn btn-sm" onclick="clearFeedSel()">Clear</button>
                    <button class="btn btn-sm btn-primary" onclick="transferToInv()">Add to Inventory</button>
                </div>
                <div class="table-wrap" style="max-height:calc(100vh - 260px);overflow-y:auto">
                    <table><thead><tr><th style="width:32px"><input type="checkbox" id="feedCheckAll" onchange="toggleAllFeed(this.checked)"></th><th style="width:80px">Image</th><th class="sortable" onclick="setSort('vehicle')">Vehicle</th><th class="sortable" onclick="setSort('stock')">Stock</th><th class="sortable" onclick="setSort('type')">Type</th><th class="sortable" onclick="setSort('price')">Price</th><th class="sortable" onclick="setSort('days')">Days</th></tr></thead><tbody id="feedBody"></tbody></table>
                </div>
            </div>
        </div>
        <div class="view" id="inventoryView" style="background:var(--bg)">
            <div class="view-header"><h2>Inventory</h2><input type="text" class="form-input" id="invSearch" placeholder="Search..." style="width:150px" oninput="renderInv()"><select class="form-select" id="invDaysFilter" onchange="renderInv()" style="width:100px"><option value="all">All Days</option><option value="0-30">0-30</option><option value="31-45">31-45</option><option value="46-60">46-60</option><option value="61+">61+</option></select><div class="spacer"></div><span class="filter-count" id="invCount">0</span><button class="btn btn-sm" onclick="shuffleVehicles()">Shuffle</button><button class="btn btn-sm" onclick="showModal('addModal')">Add</button><button class="btn btn-sm btn-danger" onclick="clearAllVehicles()">Clear</button></div>
            <div class="view-body"><div class="inv-grid" id="invGrid"></div></div>
        </div>
        <div class="view" id="designView">
            <div class="toolbar"><button class="btn btn-sm" onclick="zoomOut()">-</button><span class="zoom-label" id="zoomLabel">50%</span><button class="btn btn-sm" onclick="zoomIn()">+</button><button class="btn btn-sm" onclick="zoomFit()">Fit</button><div class="spacer"></div><button class="btn btn-sm" onclick="downloadSlide()">Export Slide</button></div>
            <div class="canvas-area" id="canvasArea"><div class="canvas-wrap" id="canvasWrap"><canvas id="mainCanvas" width="1920" height="1080"></canvas></div></div>
            <div class="canvas-nav"><button class="btn" onclick="prevVehicle()">Previous</button><div class="nav-info"><strong id="navTitle">No Vehicle</strong><span id="navSub">Add vehicles</span></div><button class="btn" onclick="nextVehicle()">Next</button></div>
        </div>
        <div class="view" id="settingsView" style="background:var(--bg)">
            <div class="view-body">
                <div class="settings-grid">
                    <div class="settings-card"><h3>Text Defaults</h3>
                        <div class="form-group"><label class="form-label">Badge</label><input type="text" class="form-input" id="badgeText" value="MANAGER'S SPECIAL" oninput="updatePreview()"></div>
                        <div class="form-group"><label class="form-label">Price Label</label><input type="text" class="form-input" id="priceLabelText" value="SPECIAL PRICE" oninput="updatePreview()"></div>
                        <div class="form-group"><label class="form-label">Highlight</label><input type="text" class="form-input" id="highlightText" value="BUY WITH $0 DOWN!" oninput="updatePreview()"></div>
                        <div class="form-row"><div class="form-group"><label class="form-label">Payment Label</label><input type="text" class="form-input" id="paymentLabel" value="OR PAYMENTS FROM" oninput="updatePreview()"></div><div class="form-group"><label class="form-label">Suffix</label><input type="text" class="form-input" id="paymentSuffix" value="/MO" oninput="updatePreview()"></div></div>
                        <div class="form-group"><label class="form-label">Disclaimer</label><textarea class="form-input form-textarea" id="disclaimer" oninput="updatePreview()">Payment with approved tier 1 credit 740+ Equifax; based on 72 month term at 6.9% APR and $3999 down payment plus tax, tag, and applicable fees. See sales consultant for details.</textarea></div>
                    </div>
                    <div class="settings-card"><h3>Layout</h3>
                        <div class="form-group"><label class="form-label">Image Position</label><select class="form-select" id="imgPos" onchange="updatePreview()"><option value="left">Left</option><option value="right">Right</option><option value="alternate">Alternate</option></select></div>
                        <div class="form-group"><label class="form-label">Image Size</label><select class="form-select" id="imgSize" onchange="updatePreview()"><option value="small">Small</option><option value="medium" selected>Medium</option><option value="large">Large</option></select></div>
                        <div class="form-group"><label class="form-label">Badge Position</label><select class="form-select" id="badgePos" onchange="updatePreview()"><option value="top-right">Top Right</option><option value="top-left">Top Left</option></select></div>
                        <div class="form-group"><label class="form-label">Card Style</label><select class="form-select" id="cardStyle" onchange="updatePreview()"><option value="shadow">Shadow</option><option value="flat">Flat</option><option value="border" selected>Border</option></select></div>
                    </div>
                    <div class="settings-card"><h3>Video</h3>
                        <div class="form-row"><div class="form-group"><label class="form-label">Resolution</label><select class="form-select" id="videoRes"><option value="1920x1080">1080p</option><option value="1280x720">720p</option></select></div><div class="form-group"><label class="form-label">FPS</label><select class="form-select" id="fps"><option value="24">24</option><option value="30" selected>30</option></select></div></div>
                        <div class="form-row"><div class="form-group"><label class="form-label">Slide (sec)</label><input type="number" class="form-input" id="slideDur" value="8" min="3" max="30"></div><div class="form-group"><label class="form-label">Transition</label><input type="number" class="form-input" id="transDur" value="1" min="0" max="3" step="0.5"></div></div>
                        <div class="form-group"><label class="form-label">Transition Type</label><select class="form-select" id="transType"><option value="slideLeft">Slide</option><option value="fade">Fade</option><option value="none">Cut</option></select></div>
                    </div>
                    <div class="settings-card"><h3>Saved Layouts</h3><div class="form-row" style="margin-bottom:10px"><input type="text" class="form-input" id="layoutName" placeholder="Name..."><button class="btn btn-sm btn-primary" onclick="saveLayout()">Save</button></div><div id="savedLayouts" style="font-size:11px;color:var(--text3)">Loading...</div></div>
                </div>
            </div>
        </div>
    </main>
    <aside class="panel">
        <div class="panel-title">Current Vehicle</div>
        <div id="cvName" style="font-weight:500;font-size:13px">No vehicle</div>
        <div id="cvStock" style="font-size:11px;color:var(--text3)">-</div>
        <div id="cvPrice" style="font-weight:700;font-size:16px;color:var(--accent);margin-top:4px">-</div>
        <div id="cvDays" style="font-size:10px;color:var(--text3);margin-top:2px"></div>
        <div class="panel-title">Overrides</div>
        <div class="form-group"><label class="form-label">Badge</label><input type="text" class="form-input" id="ovBadge" placeholder="Custom badge" oninput="updateOverride()"></div>
        <div class="form-group"><label class="form-label">Highlight</label><input type="text" class="form-input" id="ovHighlight" placeholder="Custom highlight" oninput="updateOverride()"></div>
        <div class="form-group"><label class="form-label">Accent</label><input type="text" class="form-input" id="ovColor" placeholder="#EB0A1E" oninput="updateOverride()"></div>
        <div class="toggle-row"><span>Hide Payment</span><div class="toggle" id="ovHidePay" onclick="toggleOv(this)"></div></div>
        <div class="panel-title">Typography</div>
        <div class="form-row"><div class="form-group"><label class="form-label">Year</label><select class="form-select" id="yearFont" onchange="updatePreview()"><option>Barlow Condensed</option><option>Bebas Neue</option><option>Oswald</option><option>Toyota Type</option></select></div><div class="form-group"><label class="form-label">Size</label><input type="number" class="form-input" id="yearSize" value="30" oninput="updatePreview()"></div></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Make</label><select class="form-select" id="makeFont" onchange="updatePreview()"><option>Bebas Neue</option><option>Barlow Condensed</option><option>Oswald</option><option>Toyota Type</option><option>Anton</option><option>Teko</option></select></div><div class="form-group"><label class="form-label">Size</label><input type="number" class="form-input" id="makeSize" value="66" oninput="updatePreview()"></div></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Model</label><select class="form-select" id="modelFont" onchange="updatePreview()"><option>Bebas Neue</option><option>Barlow Condensed</option><option>Oswald</option><option>Toyota Type</option></select></div><div class="form-group"><label class="form-label">Size</label><input type="number" class="form-input" id="modelSize" value="66" oninput="updatePreview()"></div></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Price</label><select class="form-select" id="priceFont" onchange="updatePreview()"><option>Bebas Neue</option><option>Barlow Condensed</option><option>Oswald</option><option>Toyota Type</option></select></div><div class="form-group"><label class="form-label">Size</label><input type="number" class="form-input" id="priceSize" value="70" oninput="updatePreview()"></div></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Highlight</label><select class="form-select" id="hlFont" onchange="updatePreview()"><option>Barlow Condensed</option><option>Bebas Neue</option><option>Montserrat</option></select></div><div class="form-group"><label class="form-label">Size</label><input type="number" class="form-input" id="hlSize" value="44" oninput="updatePreview()"></div></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Payment</label><select class="form-select" id="payFont" onchange="updatePreview()"><option>Bebas Neue</option><option>Barlow Condensed</option><option>Oswald</option></select></div><div class="form-group"><label class="form-label">Size</label><input type="number" class="form-input" id="paySize" value="60" oninput="updatePreview()"></div></div>
    </aside>
</div>
<div class="modal-overlay" id="importModal"><div class="modal"><div class="modal-header"><h3>Import</h3><button class="modal-close" onclick="closeModal('importModal')">x</button></div><div class="modal-body"><div class="drop-zone" onclick="document.getElementById('importFile').click()"><input type="file" id="importFile" accept=".json,.csv,.xlsx" hidden onchange="handleImport(event)">Click to upload CSV, XLSX, or JSON</div></div></div></div>
<div class="modal-overlay" id="feedUrlModal"><div class="modal"><div class="modal-header"><h3>Load Feed URL</h3><button class="modal-close" onclick="closeModal('feedUrlModal')">x</button></div><div class="modal-body"><div class="form-group"><label class="form-label">URL</label><input type="text" class="form-input" id="feedUrl" placeholder="https://..."></div></div><div class="modal-footer"><button class="btn" onclick="closeModal('feedUrlModal')">Cancel</button><button class="btn btn-primary" onclick="loadFeedUrl();closeModal('feedUrlModal')">Load</button></div></div></div>
<div class="modal-overlay" id="addModal"><div class="modal"><div class="modal-header"><h3>Add Vehicle</h3><button class="modal-close" onclick="closeModal('addModal')">x</button></div><div class="modal-body"><div class="form-row"><div class="form-group"><label class="form-label">Year</label><input type="text" class="form-input" id="newYear"></div><div class="form-group"><label class="form-label">Make</label><input type="text" class="form-input" id="newMake"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Model</label><input type="text" class="form-input" id="newModel"></div><div class="form-group"><label class="form-label">Trim</label><input type="text" class="form-input" id="newTrim"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Stock</label><input type="text" class="form-input" id="newStock"></div><div class="form-group"><label class="form-label">Price</label><input type="number" class="form-input" id="newPrice"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Payment</label><input type="number" class="form-input" id="newPayment"></div><div class="form-group"><label class="form-label">Down</label><input type="number" class="form-input" id="newDown" value="3999"></div></div><div class="form-group"><label class="form-label">Days</label><input type="number" class="form-input" id="newDays" value="0"></div><div class="form-group"><label class="form-label">Image URL</label><input type="text" class="form-input" id="newImg"></div></div><div class="modal-footer"><button class="btn" onclick="closeModal('addModal')">Cancel</button><button class="btn btn-primary" onclick="addVehicle()">Add</button></div></div></div>
<div class="modal-overlay" id="editModal"><div class="modal"><div class="modal-header"><h3>Edit Vehicle</h3><button class="modal-close" onclick="closeModal('editModal')">x</button></div><div class="modal-body"><input type="hidden" id="editIdx"><div class="form-row"><div class="form-group"><label class="form-label">Year</label><input type="text" class="form-input" id="editYear"></div><div class="form-group"><label class="form-label">Make</label><input type="text" class="form-input" id="editMake"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Model</label><input type="text" class="form-input" id="editModel"></div><div class="form-group"><label class="form-label">Trim</label><input type="text" class="form-input" id="editTrim"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Stock</label><input type="text" class="form-input" id="editStock"></div><div class="form-group"><label class="form-label">Price</label><input type="number" class="form-input" id="editPrice"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Payment</label><input type="number" class="form-input" id="editPayment"></div><div class="form-group"><label class="form-label">Down</label><input type="number" class="form-input" id="editDown"></div></div><div class="form-group"><label class="form-label">Days</label><input type="number" class="form-input" id="editDays"></div><div class="form-group"><label class="form-label">Image URL</label><input type="text" class="form-input" id="editImg"></div></div><div class="modal-footer"><button class="btn btn-danger" onclick="deleteVehicle(+document.getElementById('editIdx').value);closeModal('editModal')">Delete</button><div class="spacer"></div><button class="btn" onclick="closeModal('editModal')">Cancel</button><button class="btn btn-primary" onclick="saveEdit()">Save</button></div></div></div>
<div class="modal-overlay" id="progressModal"><div class="modal" style="max-width:320px"><div class="modal-body" style="text-align:center;padding:28px"><div id="progressTitle" style="font-weight:500;margin-bottom:14px">Processing...</div><div class="progress"><div class="progress-bar" id="progressBar" style="width:0"></div></div><div id="progressText" style="margin-top:10px;font-size:11px;color:var(--text3)">Please wait</div></div></div></div>
<div class="recording" id="recording">Recording...</div>
<div class="toast-wrap" id="toasts"></div>
<script>
const LOGOS=[{url:'https://res.cloudinary.com/dgcdcqjrz/image/upload/v1767624172/TOCC_BUG_-_COLOR_cag4ud.png',dark:false},{url:'https://res.cloudinary.com/dgcdcqjrz/image/upload/v1770057984/TOCC_logo_main_horz_gg6ayu.png',dark:false},{url:'https://res.cloudinary.com/dgcdcqjrz/image/upload/v1768852071/TOCC_logo_white_glow_text_y0ruv5.png',dark:true},{url:'https://res.cloudinary.com/dgcdcqjrz/image/upload/v1768852076/TOCC_logo_red_text_yyyykc.png',dark:false},{url:'https://res.cloudinary.com/dgcdcqjrz/image/upload/v1769619581/Toyota_OEM_horizontal_xciceq.png',dark:false},{url:'https://res.cloudinary.com/dgcdcqjrz/image/upload/v1769619580/Toyota_OEM_logo_only_jx3svj.png',dark:false}];
const THEMES={dark:{name:'Dark',bg:['#0f0f0f','#1a1a1a'],card:'#1a1a1a',imgBg:'#0d0d0d',text:'#fff',textSub:'#888',year:'#EB0A1E',trim:'#a1a1a1',priceLabel:'#a1a1a1',price:'#fff',hl:{bg:'#EB0A1E',text:'#fff'},badge:{bg:'#EB0A1E',text:'#fff'},payBox:{bg:'#EB0A1E',text:'#fff'},payLabel:'#EB0A1E',line:'#EB0A1E',disc:'#888'},light:{name:'Light',bg:['#e8e8e8','#f2f2f2'],card:'#fff',imgBg:'#e0e0e0',text:'#111',textSub:'#555',year:'#EB0A1E',trim:'#666',priceLabel:'#555',price:'#111',hl:{bg:'#EB0A1E',text:'#fff'},badge:{bg:'#EB0A1E',text:'#fff'},payBox:{bg:'#EB0A1E',text:'#fff'},payLabel:'#EB0A1E',line:'#EB0A1E',disc:'#777'},toyota:{name:'Red',bg:['#C4081A','#EB0A1E'],card:'rgba(0,0,0,0.25)',imgBg:'rgba(0,0,0,0.3)',text:'#fff',textSub:'rgba(255,255,255,0.8)',year:'#fff',trim:'rgba(255,255,255,0.75)',priceLabel:'rgba(255,255,255,0.8)',price:'#fff',hl:{bg:'#fff',text:'#EB0A1E'},badge:{bg:'#fff',text:'#EB0A1E'},payBox:{bg:'#fff',text:'#EB0A1E'},payLabel:'#fff',line:'rgba(255,255,255,0.5)',disc:'rgba(255,255,255,0.6)'},gold:{name:'Gold',bg:['#050505','#0a0a0a'],card:'#0c0c0c',imgBg:'#080808',text:'#fff',textSub:'#888',year:'#D4AF37',trim:'#888',priceLabel:'#888',price:'#fff',hl:{bg:'#D4AF37',text:'#000'},badge:{bg:'#D4AF37',text:'#000'},payBox:{bg:'#D4AF37',text:'#000'},payLabel:'#D4AF37',line:'#D4AF37',disc:'#555'},memorial:{name:'Memorial',bg:['#0D1B2A','#1B2838'],card:'#1e3a50',imgBg:'#152535',text:'#fff',textSub:'#a0b4c8',year:'#E53935',trim:'#90a4b8',priceLabel:'#a0b4c8',price:'#fff',hl:{bg:'#E53935',text:'#fff'},badge:{bg:'#1565C0',text:'#fff'},payBox:{bg:'#E53935',text:'#fff'},payLabel:'#E53935',line:'#fff',disc:'#7090a8'},july4th:{name:'July 4th',bg:['#002868','#0A3A7A'],card:'#0d3d80',imgBg:'#082d60',text:'#fff',textSub:'#b8c8e8',year:'#BF0A30',trim:'#a8b8d8',priceLabel:'#b8c8e8',price:'#fff',hl:{bg:'#BF0A30',text:'#fff'},badge:{bg:'#BF0A30',text:'#fff'},payBox:{bg:'#BF0A30',text:'#fff'},payLabel:'#fff',line:'#fff',disc:'#8898b8'},summer:{name:'Summer',bg:['#0077B6','#00B4D8'],card:'rgba(255,255,255,0.15)',imgBg:'rgba(0,0,0,0.2)',text:'#fff',textSub:'rgba(255,255,255,0.85)',year:'#FFD166',trim:'rgba(255,255,255,0.75)',priceLabel:'rgba(255,255,255,0.85)',price:'#fff',hl:{bg:'#FFD166',text:'#0077B6'},badge:{bg:'#fff',text:'#0077B6'},payBox:{bg:'#FFD166',text:'#0077B6'},payLabel:'#FFD166',line:'#FFD166',disc:'rgba(255,255,255,0.6)'},fall:{name:'Fall',bg:['#2D1B0E','#4A2C17'],card:'#3d2414',imgBg:'#251508',text:'#FFF8F0',textSub:'#D4A574',year:'#FF8C00',trim:'#C49664',priceLabel:'#D4A574',price:'#FFF8F0',hl:{bg:'#FF8C00',text:'#2D1B0E'},badge:{bg:'#DC143C',text:'#fff'},payBox:{bg:'#FF8C00',text:'#2D1B0E'},payLabel:'#FF8C00',line:'#FF8C00',disc:'#A08060'},holiday:{name:'Holiday',bg:['#1B4332','#2D6A4F'],card:'#245740',imgBg:'#153728',text:'#fff',textSub:'#A7C4A0',year:'#DC143C',trim:'#95B88F',priceLabel:'#A7C4A0',price:'#fff',hl:{bg:'#DC143C',text:'#fff'},badge:{bg:'#FFD700',text:'#1B4332'},payBox:{bg:'#DC143C',text:'#fff'},payLabel:'#FFD700',line:'#FFD700',disc:'#74A37A'}};
const M=80;let slideTheme='dark',logoIdx=4,logoImg=null,zoom=0.5,vehicles=[],currentIdx=0,feedVehicles=[],selectedIds=new Set(),feedSort={col:'days',dir:'asc'},visibility={showBadge:true,showStock:true,showYear:true,showTrim:true,showPriceLabel:true,showHighlight:true,showPayment:true,showDown:false,showDisclaimer:true};
document.addEventListener('DOMContentLoaded',()=>{loadStorage();renderThemes();renderLogos();renderFeed();renderInv();updatePanel();document.addEventListener('keydown',e=>{if(['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName))return;if(e.key==='Escape')closeAllModals();if(e.key==='ArrowLeft')prevVehicle();if(e.key==='ArrowRight')nextVehicle();});});
function switchView(v){document.querySelectorAll('.nav-item').forEach(n=>n.classList.toggle('active',n.dataset.view===v));document.querySelectorAll('.view').forEach(el=>el.classList.remove('active'));document.getElementById(v+'View').classList.add('active');if(v==='design'){setTimeout(()=>{initCanvas();loadLogo().then(updatePreview);},50);}if(v==='inventory')renderInv();}
function renderThemes(){document.getElementById('themeGrid').innerHTML=Object.entries(THEMES).map(([k,t])=>`<div class="theme-card ${k===slideTheme?'selected':''}" onclick="selectTheme('${k}')"><div class="theme-preview" style="background:linear-gradient(135deg,${t.bg[0]},${t.bg[1]})"></div><div class="theme-name">${t.name}</div></div>`).join('');}
function selectTheme(t){slideTheme=t;renderThemes();saveStorage();updatePreview();}
function renderLogos(){document.getElementById('logoGrid').innerHTML=LOGOS.map((l,i)=>`<div class="logo-option ${i===logoIdx?'selected':''} ${l.dark?'dark-bg':''}" onclick="selectLogo(${i})"><img src="${l.url}"></div>`).join('');}
function selectLogo(i){logoIdx=i;renderLogos();saveStorage();loadLogo().then(updatePreview);}
async function loadLogo(){const l=LOGOS[logoIdx];if(!l)return;return new Promise(r=>{const img=new Image();img.crossOrigin='anonymous';img.onload=()=>{logoImg=img;r();};img.onerror=r;img.src=l.url;});}
function initCanvas(){const c=document.getElementById('canvasArea'),w=document.getElementById('canvasWrap');if(!c)return;const r=c.getBoundingClientRect();zoom=Math.max(0.25,Math.min((r.width-32)/1920,(r.height-32)/1080,1));w.style.width=Math.floor(1920*zoom)+'px';w.style.height=Math.floor(1080*zoom)+'px';document.getElementById('zoomLabel').textContent=Math.round(zoom*100)+'%';}
function zoomIn(){zoom=Math.min(1,zoom+0.1);updateZoom();}function zoomOut(){zoom=Math.max(0.2,zoom-0.1);updateZoom();}function zoomFit(){initCanvas();}
function updateZoom(){const w=document.getElementById('canvasWrap');w.style.width=Math.floor(1920*zoom)+'px';w.style.height=Math.floor(1080*zoom)+'px';document.getElementById('zoomLabel').textContent=Math.round(zoom*100)+'%';}
let updateTO;function updatePreview(){clearTimeout(updateTO);updateTO=setTimeout(()=>{const ctx=document.getElementById('mainCanvas').getContext('2d');const v=vehicles[currentIdx]||{year:'2025',make:'Toyota',model:'Camry',trim:'XSE',stock:'T12345',price:34999,payment:499,down:3999,days:0,imageUrl:'',imageObj:null};loadImg(v).then(()=>drawSlide(ctx,v,1920,1080,1,currentIdx));},50);}
async function loadImg(v){if(v.imageObj||!v.imageUrl)return;return new Promise(r=>{const img=new Image();img.crossOrigin='anonymous';img.onload=()=>{v.imageObj=img;r();};img.onerror=r;img.src=v.imageUrl;});}
function rr(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();}
function getTypo(){return{year:{font:document.getElementById('yearFont')?.value||'Barlow Condensed',size:+document.getElementById('yearSize')?.value||30},make:{font:document.getElementById('makeFont')?.value||'Bebas Neue',size:+document.getElementById('makeSize')?.value||66},model:{font:document.getElementById('modelFont')?.value||'Bebas Neue',size:+document.getElementById('modelSize')?.value||66},price:{font:document.getElementById('priceFont')?.value||'Bebas Neue',size:+document.getElementById('priceSize')?.value||70},hl:{font:document.getElementById('hlFont')?.value||'Barlow Condensed',size:+document.getElementById('hlSize')?.value||44},pay:{font:document.getElementById('payFont')?.value||'Bebas Neue',size:+document.getElementById('paySize')?.value||60}};}
function drawSlide(ctx,v,W,H,opacity,idx){const T=THEMES[slideTheme],TY=getTypo();const S={badge:document.getElementById('badgeText')?.value||"MANAGER'S SPECIAL",priceLabel:document.getElementById('priceLabelText')?.value||'SPECIAL PRICE',highlight:document.getElementById('highlightText')?.value||'BUY WITH $0 DOWN!',payLabel:document.getElementById('paymentLabel')?.value||'OR PAYMENTS FROM',paySuffix:document.getElementById('paymentSuffix')?.value||'/MO',disc:document.getElementById('disclaimer')?.value||'',logoSize:+document.getElementById('logoSize')?.value||108,imgPos:document.getElementById('imgPos')?.value||'left',imgSize:document.getElementById('imgSize')?.value||'medium',badgePos:document.getElementById('badgePos')?.value||'top-right',cardStyle:document.getElementById('cardStyle')?.value||'border'};const accent=v.overrideAccentColor||null,badgeTxt=v.overrideBadge||S.badge,hlTxt=v.overrideHighlight||S.highlight,showPay=visibility.showPayment&&!v.hidePayment&&v.payment>0;const badgeBg=accent||T.badge.bg,hlBg=accent||T.hl.bg,payBg=accent||T.payBox.bg,yearC=accent||T.year,lineC=accent||T.line;let imgR=S.imgPos==='right';if(S.imgPos==='alternate')imgR=idx%2===1;const badgeL=S.badgePos==='top-left';ctx.globalAlpha=opacity;const bg=ctx.createLinearGradient(0,0,W,H);bg.addColorStop(0,T.bg[0]);bg.addColorStop(1,T.bg[1]);ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);const hg=ctx.createLinearGradient(0,0,0,180);hg.addColorStop(0,'rgba(0,0,0,0.3)');hg.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=hg;ctx.fillRect(0,0,W,180);if(logoImg){const r=logoImg.width/logoImg.height,lW=S.logoSize*r,lH=S.logoSize,lX=badgeL?W-M-lW:M;ctx.drawImage(logoImg,lX,M-10,lW,lH);}if(visibility.showBadge){ctx.font='700 22px "Montserrat",sans-serif';const bW=ctx.measureText(badgeTxt).width+36,bH=44,bX=badgeL?M:W-M-bW,bY=M-8;ctx.fillStyle=badgeBg;rr(ctx,bX,bY,bW,bH,4);ctx.fill();ctx.fillStyle=T.badge.text;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(badgeTxt,bX+bW/2,bY+bH/2);ctx.textAlign='left';ctx.textBaseline='alphabetic';}const cX=M,cY=M+100,cW=W-M*2,cH=H-cY-M-(visibility.showDisclaimer?50:20);if(S.cardStyle==='shadow'){ctx.fillStyle='rgba(0,0,0,0.4)';rr(ctx,cX+4,cY+4,cW,cH,16);ctx.fill();}ctx.fillStyle=T.card;rr(ctx,cX,cY,cW,cH,16);ctx.fill();if(S.cardStyle==='border'){ctx.strokeStyle=accent||T.line;ctx.lineWidth=3;rr(ctx,cX,cY,cW,cH,16);ctx.stroke();}const imgRatios={small:0.40,medium:0.46,large:0.52},imgRatio=imgRatios[S.imgSize]||0.46,imgPad=24,imgW=cW*imgRatio,imgH=cH-imgPad*2,imgX=imgR?cX+cW-imgPad-imgW:cX+imgPad,imgY=cY+imgPad;ctx.fillStyle=T.imgBg;rr(ctx,imgX,imgY,imgW,imgH,12);ctx.fill();if(v.imageObj){ctx.save();rr(ctx,imgX,imgY,imgW,imgH,12);ctx.clip();const ir=v.imageObj.width/v.imageObj.height,ar=imgW/imgH;let dw,dh,dx,dy;if(ir>ar){dh=imgH;dw=dh*ir;dx=imgX+(imgW-dw)/2;dy=imgY;}else{dw=imgW;dh=dw/ir;dx=imgX;dy=imgY+(imgH-dh)/2;}ctx.drawImage(v.imageObj,dx,dy,dw,dh);ctx.restore();}const infoX=imgR?cX+imgPad+30:imgX+imgW+50,infoW=cW-imgW-imgPad-100;let Y=cY+50;if(visibility.showStock){ctx.font='600 18px "DM Sans",sans-serif';const sTxt='Stock #'+v.stock,sW=ctx.measureText(sTxt).width+20,sH=32;ctx.fillStyle='rgba(128,128,128,0.15)';rr(ctx,infoX+infoW-sW,Y,sW,sH,sH/2);ctx.fill();ctx.fillStyle=T.textSub;ctx.textBaseline='middle';ctx.fillText(sTxt,infoX+infoW-sW+10,Y+sH/2);ctx.textBaseline='alphabetic';}Y+=55;if(visibility.showYear){ctx.font=`700 ${TY.year.size}px "${TY.year.font}",sans-serif`;ctx.fillStyle=yearC;ctx.fillText(v.year,infoX,Y);Y+=TY.year.size+5;}let fs=TY.make.size;ctx.font=`400 ${fs}px "${TY.make.font}",sans-serif`;while(ctx.measureText(v.make.toUpperCase()).width>infoW-20&&fs>30){fs-=2;ctx.font=`400 ${fs}px "${TY.make.font}",sans-serif`;}ctx.fillStyle=T.text;ctx.fillText(v.make.toUpperCase(),infoX,Y);Y+=fs-15;fs=TY.model.size;ctx.font=`400 ${fs}px "${TY.model.font}",sans-serif`;while(ctx.measureText(v.model.toUpperCase()).width>infoW-20&&fs>30){fs-=2;ctx.font=`400 ${fs}px "${TY.model.font}",sans-serif`;}ctx.fillText(v.model.toUpperCase(),infoX,Y);Y+=fs-15;if(visibility.showTrim){ctx.font='600 26px "DM Sans",sans-serif';ctx.fillStyle=T.trim;ctx.fillText(v.trim.toUpperCase(),infoX,Y);Y+=50;}else{Y+=15;}if(visibility.showPriceLabel){ctx.font='600 18px "DM Sans",sans-serif';ctx.fillStyle=T.priceLabel;ctx.fillText(S.priceLabel.toUpperCase(),infoX,Y);Y+=28;}ctx.font=`400 ${TY.price.size}px "${TY.price.font}",sans-serif`;ctx.fillStyle=T.price;const pTxt='$'+v.price.toLocaleString(),pW=ctx.measureText(pTxt).width;ctx.fillText(pTxt,infoX,Y+TY.price.size*0.75);if(visibility.showHighlight){ctx.font=`700 ${TY.hl.size}px "${TY.hl.font}",sans-serif`;const hlW=ctx.measureText(hlTxt).width+28,hlH=TY.hl.size+16,hlX=infoX+pW+24,hlY=Y+(TY.price.size*0.75)/2-hlH/2+10;ctx.fillStyle=hlBg;rr(ctx,hlX,hlY,hlW,hlH,4);ctx.fill();ctx.fillStyle=T.hl.text;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(hlTxt,hlX+hlW/2,hlY+hlH/2);ctx.textAlign='left';ctx.textBaseline='alphabetic';}if(showPay){Y+=TY.price.size+30;ctx.font='700 20px "DM Sans",sans-serif';ctx.fillStyle=accent||T.payLabel;const plTxt=S.payLabel.toUpperCase(),plW=ctx.measureText(plTxt).width;ctx.strokeStyle=lineC;ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(infoX,Y-4);ctx.lineTo(infoX+40,Y-4);ctx.stroke();ctx.fillText(plTxt,infoX+52,Y);ctx.beginPath();ctx.moveTo(infoX+52+plW+12,Y-4);ctx.lineTo(infoX+52+plW+52,Y-4);ctx.stroke();Y+=28;const payTxt='$'+v.payment+S.paySuffix;ctx.font=`400 ${TY.pay.size}px "${TY.pay.font}",sans-serif`;const payW=ctx.measureText(payTxt).width,boxW=payW+50,boxH=TY.pay.size+26;ctx.fillStyle=payBg;rr(ctx,infoX,Y,boxW,boxH,8);ctx.fill();ctx.fillStyle=T.payBox.text;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(payTxt,infoX+boxW/2,Y+boxH/2+2);ctx.textAlign='left';ctx.textBaseline='alphabetic';if(visibility.showDown&&v.down>0){ctx.font='500 16px "DM Sans",sans-serif';ctx.fillStyle=T.textSub;ctx.fillText('with $'+v.down.toLocaleString()+' down',infoX,Y+boxH+24);}}if(visibility.showDisclaimer&&S.disc){ctx.font='400 18px "Inter",sans-serif';ctx.fillStyle=T.disc;ctx.textAlign='center';ctx.fillText(S.disc,W/2,H-M+24);ctx.textAlign='left';}ctx.globalAlpha=1;}
function toggleVis(el){const k=el.id;visibility[k]=!visibility[k];el.classList.toggle('active',visibility[k]);saveStorage();updatePreview();}
function updatePanel(){const v=vehicles[currentIdx];document.getElementById('cvName').textContent=v?`${v.year} ${v.make} ${v.model}`:'No vehicle';document.getElementById('cvStock').textContent=v?`#${v.stock} - ${v.trim}`:'-';document.getElementById('cvPrice').textContent=v?'$'+v.price.toLocaleString():'-';document.getElementById('cvDays').textContent=v&&v.days!=null?v.days+' days':'';document.getElementById('navTitle').textContent=v?`${v.year} ${v.make} ${v.model}`:'No Vehicle';document.getElementById('navSub').textContent=v?`${currentIdx+1} of ${vehicles.length}`:'Add vehicles';document.getElementById('invBadge').textContent=vehicles.length;if(v){document.getElementById('ovBadge').value=v.overrideBadge||'';document.getElementById('ovHighlight').value=v.overrideHighlight||'';document.getElementById('ovColor').value=v.overrideAccentColor||'';document.getElementById('ovHidePay').classList.toggle('active',v.hidePayment);}}
function updateOverride(){if(!vehicles[currentIdx])return;vehicles[currentIdx].overrideBadge=document.getElementById('ovBadge').value;vehicles[currentIdx].overrideHighlight=document.getElementById('ovHighlight').value;vehicles[currentIdx].overrideAccentColor=document.getElementById('ovColor').value;saveStorage();updatePreview();}
function toggleOv(el){if(!vehicles[currentIdx])return;el.classList.toggle('active');vehicles[currentIdx].hidePayment=el.classList.contains('active');saveStorage();updatePreview();}
function prevVehicle(){if(!vehicles.length)return;currentIdx=(currentIdx-1+vehicles.length)%vehicles.length;updatePanel();updatePreview();}
function nextVehicle(){if(!vehicles.length)return;currentIdx=(currentIdx+1)%vehicles.length;updatePanel();updatePreview();}
function filterDays(v,f){if(f==='all')return true;const d=v.days??0;if(f==='0-30')return d<=30;if(f==='31-45')return d>=31&&d<=45;if(f==='46-60')return d>=46&&d<=60;if(f==='61+')return d>=61;return true;}
function renderInv(){const search=(document.getElementById('invSearch')?.value||'').toLowerCase(),daysF=document.getElementById('invDaysFilter')?.value||'all';const filtered=vehicles.filter(v=>{if(!filterDays(v,daysF))return false;if(search&&!`${v.year} ${v.make} ${v.model} ${v.trim} ${v.stock}`.toLowerCase().includes(search))return false;return true;});document.getElementById('invCount').textContent=filtered.length+' vehicles';document.getElementById('invBadge').textContent=vehicles.length;if(!filtered.length){document.getElementById('invGrid').innerHTML='<div class="empty">No vehicles</div>';return;}document.getElementById('invGrid').innerHTML=filtered.map(v=>{const i=vehicles.indexOf(v),dc=v.days>=61?'danger':v.days>=46?'warn':'';return`<div class="inv-card">${v.imageUrl?`<img class="inv-card-img" src="${v.imageUrl}" onerror="this.style.display='none'">`:'<div class="inv-card-img"></div>'}<div class="inv-card-body"><div class="inv-card-title">${v.year} ${v.make} ${v.model}</div><div class="inv-card-sub">${v.trim} - #${v.stock}</div><div class="inv-card-price">$${v.price.toLocaleString()}</div><div class="inv-card-days"><span class="days-badge ${dc}">${v.days??0} days</span></div><div class="inv-card-actions"><button class="btn btn-sm" onclick="goTo(${i})">View</button><button class="btn btn-sm" onclick="openEdit(${i})">Edit</button><button class="btn btn-sm btn-danger" onclick="deleteVehicle(${i})">Del</button></div></div></div>`;}).join('');}
function goTo(i){currentIdx=i;switchView('design');updatePanel();updatePreview();}
function addVehicle(){const rate=+document.getElementById('globalRate').value||6.9,term=+document.getElementById('globalTerm').value||72,down=+document.getElementById('newDown').value||3999,price=+document.getElementById('newPrice').value||0;let pay=+document.getElementById('newPayment').value||0;if(!pay&&price)pay=calcPay(price,rate,term,down);vehicles.push({year:document.getElementById('newYear').value,make:document.getElementById('newMake').value,model:document.getElementById('newModel').value,trim:document.getElementById('newTrim').value,stock:document.getElementById('newStock').value,price,payment:pay,down,days:+document.getElementById('newDays').value||0,imageUrl:document.getElementById('newImg').value,imageObj:null,overrideBadge:'',overrideHighlight:'',overrideAccentColor:'',hidePayment:false});currentIdx=vehicles.length-1;saveStorage();renderInv();updatePanel();closeModal('addModal');['newYear','newMake','newModel','newTrim','newStock','newPrice','newPayment','newImg'].forEach(id=>document.getElementById(id).value='');document.getElementById('newDays').value='0';document.getElementById('newDown').value='3999';toast('Added');}
function openEdit(i){const v=vehicles[i];document.getElementById('editIdx').value=i;document.getElementById('editYear').value=v.year;document.getElementById('editMake').value=v.make;document.getElementById('editModel').value=v.model;document.getElementById('editTrim').value=v.trim;document.getElementById('editStock').value=v.stock;document.getElementById('editPrice').value=v.price;document.getElementById('editPayment').value=v.payment;document.getElementById('editDown').value=v.down;document.getElementById('editDays').value=v.days??0;document.getElementById('editImg').value=v.imageUrl;showModal('editModal');}
function saveEdit(){const i=+document.getElementById('editIdx').value,v=vehicles[i];if(!v)return;v.year=document.getElementById('editYear').value;v.make=document.getElementById('editMake').value;v.model=document.getElementById('editModel').value;v.trim=document.getElementById('editTrim').value;v.stock=document.getElementById('editStock').value;v.price=+document.getElementById('editPrice').value||0;v.payment=+document.getElementById('editPayment').value||0;v.down=+document.getElementById('editDown').value||0;v.days=+document.getElementById('editDays').value||0;v.imageUrl=document.getElementById('editImg').value;v.imageObj=null;saveStorage();renderInv();updatePanel();updatePreview();closeModal('editModal');toast('Saved');}
function deleteVehicle(i){vehicles.splice(i,1);if(currentIdx>=vehicles.length)currentIdx=Math.max(0,vehicles.length-1);saveStorage();renderInv();updatePanel();updatePreview();toast('Deleted');}
function shuffleVehicles(){for(let i=vehicles.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[vehicles[i],vehicles[j]]=[vehicles[j],vehicles[i]];}currentIdx=0;saveStorage();renderInv();updatePanel();updatePreview();toast('Shuffled');}
function clearAllVehicles(){if(!vehicles.length||!confirm('Delete all?'))return;vehicles=[];currentIdx=0;saveStorage();renderInv();updatePanel();updatePreview();toast('Cleared');}
function loadFeedFile(ev){const f=ev.target.files[0];if(!f)return;const isXL=f.name.endsWith('.xlsx')||f.name.endsWith('.xls');if(isXL){const r=new FileReader();r.onload=e=>{try{const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});parseCSV(XLSX.utils.sheet_to_csv(wb.Sheets[wb.SheetNames[0]]));toast('Loaded');}catch(err){toast('Error');}};r.readAsArrayBuffer(f);}else{const r=new FileReader();r.onload=e=>{try{parseCSV(e.target.result);toast('Loaded');}catch(err){toast('Error');}};r.readAsText(f);}ev.target.value='';}
async function loadFeedUrl(){const url=document.getElementById('feedUrl').value.trim();if(!url)return toast('Enter URL');let fetchUrl=url;if(url.includes('docs.google.com/spreadsheets')){const m=url.match(/\/d\/([a-zA-Z0-9-_]+)/);if(m)fetchUrl=`https://docs.google.com/spreadsheets/d/${m[1]}/export?format=csv`;}try{let res=await fetch(fetchUrl);if(!res.ok)res=await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(fetchUrl)}`);if(res.ok){parseCSV(await res.text());toast('Loaded');}else toast('Failed');}catch(e){toast('Failed');}}
function parseCSV(text){const rows=[];let row=[],field='',i=0,inQ=false;while(i<text.length){const c=text[i];if(inQ){if(c==='"'){if(text[i+1]==='"'){field+='"';i+=2;continue;}inQ=false;i++;continue;}field+=c;i++;}else{if(c==='"'){inQ=true;i++;continue;}if(c===','){row.push(field);field='';i++;continue;}if(c==='\r'){i++;continue;}if(c==='\n'){row.push(field);field='';rows.push(row);row=[];i++;continue;}field+=c;i++;}}row.push(field);if(row.length>1||row[0].trim())rows.push(row);if(rows.length<2)throw new Error('No data');const h=rows[0].map(s=>(s||'').toLowerCase().trim()),idx=n=>h.findIndex(x=>x===n.toLowerCase()),col={vin:idx('vin'),stock:idx('stock #'),type:idx('new/used'),year:idx('year'),make:idx('make'),model:idx('model'),series:idx('series'),price:idx('price'),invDate:idx('inventory date'),photo:idx('photo url list')};feedVehicles=[];for(let i=1;i<rows.length;i++){const r=rows[i];if(!r||r.length<5)continue;const stock=(col.stock>=0?r[col.stock]:'').trim(),vin=(col.vin>=0?r[col.vin]:'').trim();if(!stock&&!vin)continue;const price=parseInt(String(col.price>=0?r[col.price]:'').replace(/[^0-9]/g,''))||0,photoList=col.photo>=0?r[col.photo]:'',imageUrl=(photoList||'').split('|')[0].trim(),invDate=col.invDate>=0?r[col.invDate]:'',days=calcDays(invDate);feedVehicles.push({id:`${stock||vin}_${i}`,vin,stock,type:(col.type>=0?(r[col.type]||'').trim():''),year:(col.year>=0?r[col.year]:'').trim(),make:(col.make>=0?r[col.make]:'').trim(),model:(col.model>=0?r[col.model]:'').trim(),series:(col.series>=0?(r[col.series]||'').trim():''),price,days,imageUrl:imageUrl&&imageUrl!=='.'?imageUrl:''});}selectedIds=new Set();hydrateDropdowns();renderFeed();}
function calcDays(s){if(!s)return null;const p=String(s).split('/');if(p.length!==3)return null;const d=new Date(parseInt(p[2]),parseInt(p[0])-1,parseInt(p[1]));if(isNaN(d))return null;return Math.max(0,Math.floor((Date.now()-d)/86400000));}
function hydrateDropdowns(){const makes=[...new Set(feedVehicles.map(v=>v.make).filter(Boolean))].sort(),years=[...new Set(feedVehicles.map(v=>v.year).filter(Boolean))].sort((a,b)=>b-a);document.getElementById('feedMake').innerHTML='<option value="all">All Makes</option>'+makes.map(m=>`<option>${m}</option>`).join('');document.getElementById('feedModel').innerHTML='<option value="all">All Models</option>';document.getElementById('feedYear').innerHTML='<option value="all">All Years</option>'+years.map(y=>`<option>${y}</option>`).join('');}
function onMakeChange(){const make=document.getElementById('feedMake').value;const models=make==='all'?[...new Set(feedVehicles.map(v=>v.model).filter(Boolean))]:[...new Set(feedVehicles.filter(v=>v.make===make).map(v=>v.model).filter(Boolean))];models.sort();document.getElementById('feedModel').innerHTML='<option value="all">All Models</option>'+models.map(m=>`<option>${m}</option>`).join('');renderFeed();}
function getFilters(){return{q:(document.getElementById('feedSearch')?.value||'').toLowerCase(),type:document.getElementById('feedType')?.value||'all',make:document.getElementById('feedMake')?.value||'all',model:document.getElementById('feedModel')?.value||'all',year:document.getElementById('feedYear')?.value||'all',days:document.getElementById('feedDays')?.value||'all',hasImg:document.getElementById('feedHasImg')?.checked};}
function filteredFeed(){const f=getFilters();return feedVehicles.filter(v=>{if(f.hasImg&&!v.imageUrl)return false;if(f.type!=='all'&&(v.type||'').toUpperCase()!==f.type)return false;if(f.make!=='all'&&v.make!==f.make)return false;if(f.model!=='all'&&v.model!==f.model)return false;if(f.year!=='all'&&v.year!==f.year)return false;if(!filterDays(v,f.days))return false;if(f.q&&!`${v.stock} ${v.vin}`.toLowerCase().includes(f.q))return false;return true;});}
function setSort(col){if(feedSort.col===col)feedSort.dir=feedSort.dir==='asc'?'desc':'asc';else{feedSort.col=col;feedSort.dir='asc';}renderFeed();}
function sortedFeed(list){const dir=feedSort.dir==='asc'?1:-1,col=feedSort.col;return list.slice().sort((a,b)=>{const va=col==='price'?a.price:col==='days'?(a.days??999999):col==='type'?a.type:col==='stock'?a.stock:`${a.year} ${a.make} ${a.model}`;const vb=col==='price'?b.price:col==='days'?(b.days??999999):col==='type'?b.type:col==='stock'?b.stock:`${b.year} ${b.make} ${b.model}`;if(typeof va==='number'&&typeof vb==='number')return(va-vb)*dir;return String(va).localeCompare(String(vb))*dir;});}
function renderFeed(){const list=sortedFeed(filteredFeed());document.getElementById('feedCount').textContent=`${list.length} of ${feedVehicles.length}`;if(!list.length){document.getElementById('feedBody').innerHTML='<tr><td colspan="7" style="text-align:center;padding:24px;color:var(--text3)">No vehicles</td></tr>';return;}document.getElementById('feedBody').innerHTML=list.map(v=>{const sel=selectedIds.has(v.id),dc=v.days>=61?'danger':v.days>=46?'warn':'';return`<tr class="${sel?'selected':''}" onclick="toggleRow('${v.id}')"><td><input type="checkbox" ${sel?'checked':''} onclick="event.stopPropagation();toggleRow('${v.id}')"></td><td>${v.imageUrl?`<img class="thumb" src="${v.imageUrl}">`:'<div class="thumb"></div>'}</td><td><div class="v-name">${v.year} ${v.make} ${v.model}</div><div class="v-trim">${v.series}</div></td><td>${v.stock}</td><td>${v.type==='N'?'New':v.type==='U'?'Used':v.type}</td><td>$${v.price.toLocaleString()}</td><td><span class="days-badge ${dc}">${v.days??'-'}</span></td></tr>`;}).join('');}
function toggleAllFeed(checked){sortedFeed(filteredFeed()).forEach(v=>{if(checked)selectedIds.add(v.id);else selectedIds.delete(v.id);});renderFeed();}
function toggleRow(id){if(selectedIds.has(id))selectedIds.delete(id);else selectedIds.add(id);renderFeed();}
function selectAllFeed(){sortedFeed(filteredFeed()).forEach(v=>selectedIds.add(v.id));renderFeed();toast('Selected '+selectedIds.size);}
function clearFeedSel(){selectedIds=new Set();document.getElementById('feedCheckAll').checked=false;renderFeed();}
function roundTo9(p){return Math.ceil(p/10)*10-1;}
function calcPay(price,rate,term,down){const prin=(price||0)-(down||0);if(prin<=0)return 0;const mr=(rate||0)/100/12;if(!mr)return roundTo9(prin/(term||1));return roundTo9(prin*(mr*Math.pow(1+mr,term))/(Math.pow(1+mr,term)-1));}
function transferToInv(){const sel=feedVehicles.filter(v=>selectedIds.has(v.id));if(!sel.length)return toast('Select vehicles');const rate=+document.getElementById('globalRate').value||6.9,term=+document.getElementById('globalTerm').value||72,down=+document.getElementById('globalDown').value||3999;sel.forEach(fv=>{vehicles.push({year:fv.year,make:fv.make,model:fv.model,trim:fv.series,stock:fv.stock,price:fv.price,payment:calcPay(fv.price,rate,term,down),down,days:fv.days??0,imageUrl:fv.imageUrl,imageObj:null,overrideBadge:'',overrideHighlight:'',overrideAccentColor:'',hidePayment:false});});saveStorage();selectedIds=new Set();renderFeed();renderInv();updatePanel();toast('Added '+sel.length);}
function saveStorage(){const data={vehicles:vehicles.map(v=>({...v,imageObj:null})),logoIdx,slideTheme,visibility};localStorage.setItem('slideshower2001',JSON.stringify(data));}
function loadStorage(){const s=localStorage.getItem('slideshower2001');if(s){try{const d=JSON.parse(s);vehicles=(d.vehicles||[]).map(v=>({...v,imageObj:null}));logoIdx=d.logoIdx??4;slideTheme=d.slideTheme||'dark';if(d.visibility)visibility={...visibility,...d.visibility};}catch(e){}}}
async function saveLayout(){if(!window.firebaseReady)return toast('Firebase not ready');const name=document.getElementById('layoutName').value.trim();if(!name)return toast('Enter name');try{await window.fbHelpers.setDoc(window.fbHelpers.doc(window.db,'layouts',name.toLowerCase().replace(/\s+/g,'-')),{name,slideTheme,logoIdx,visibility,createdAt:new Date().toISOString()});document.getElementById('layoutName').value='';loadLayouts();toast('Saved');}catch(e){toast('Failed');}}
async function loadLayouts(){if(!window.firebaseReady){document.getElementById('savedLayouts').textContent='Connecting...';return;}try{const snap=await window.fbHelpers.getDocs(window.fbHelpers.collection(window.db,'layouts'));if(snap.empty){document.getElementById('savedLayouts').textContent='No layouts';return;}document.getElementById('savedLayouts').innerHTML=snap.docs.map(d=>{const data=d.data();return`<div style="padding:6px 8px;border:1px solid var(--border);border-radius:var(--radius);margin-bottom:4px;cursor:pointer" onclick="loadLayout('${d.id}')"><strong>${data.name}</strong> <span style="color:var(--text3)">${data.slideTheme}</span></div>`;}).join('');}catch(e){document.getElementById('savedLayouts').textContent='Error loading';}}
async function loadLayout(id){try{const snap=await window.fbHelpers.getDoc(window.fbHelpers.doc(window.db,'layouts',id));if(snap.exists()){const d=snap.data();slideTheme=d.slideTheme||'dark';logoIdx=d.logoIdx??4;if(d.visibility)visibility={...visibility,...d.visibility};saveStorage();renderThemes();renderLogos();updatePreview();toast('Loaded');}}catch(e){toast('Failed');}}
function handleImport(ev){const f=ev.target.files[0];if(!f)return;if(f.name.endsWith('.json')){const r=new FileReader();r.onload=e=>{try{const d=JSON.parse(e.target.result);vehicles=(d.vehicles||[]).map(v=>({...v,imageObj:null}));logoIdx=d.logoIdx??4;slideTheme=d.slideTheme||'dark';if(d.visibility)visibility={...visibility,...d.visibility};saveStorage();renderInv();updatePanel();renderThemes();renderLogos();closeModal('importModal');toast('Imported '+vehicles.length);}catch(err){toast('Error');}};r.readAsText(f);}else if(f.name.endsWith('.xlsx')||f.name.endsWith('.xls')){const r=new FileReader();r.onload=e=>{try{const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});parseCSV(XLSX.utils.sheet_to_csv(wb.Sheets[wb.SheetNames[0]]));closeModal('importModal');}catch(err){toast('Error');}};r.readAsArrayBuffer(f);}else{const r=new FileReader();r.onload=e=>{try{parseCSV(e.target.result);closeModal('importModal');}catch(err){toast('Error');}};r.readAsText(f);}ev.target.value='';}
function exportProject(){const data={version:'2001',vehicles:vehicles.map(v=>({...v,imageObj:null})),logoIdx,slideTheme,visibility};const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'}));a.download=`slideshow-${Date.now()}.json`;a.click();toast('Exported');}
function previewSlideshow(){if(!vehicles.length)return toast('Add vehicles');let idx=0;const show=()=>{currentIdx=idx;updatePanel();updatePreview();idx=(idx+1)%vehicles.length;};show();setInterval(show,(+document.getElementById('slideDur')?.value||8)*1000);toast('Previewing');}
async function generateVideo(){if(!vehicles.length)return toast('Add vehicles');showModal('progressModal');document.getElementById('progressTitle').textContent='Generating...';document.getElementById('progressText').textContent='Loading images...';document.getElementById('progressBar').style.width='5%';for(let i=0;i<vehicles.length;i++){await loadImg(vehicles[i]);document.getElementById('progressBar').style.width=(5+(i/vehicles.length)*35)+'%';}const res=(document.getElementById('videoRes')?.value||'1920x1080').split('x'),W=+res[0],H=+res[1],fps=+document.getElementById('fps')?.value||30,slideDur=+document.getElementById('slideDur')?.value||8,transDur=+document.getElementById('transDur')?.value||1,transType=document.getElementById('transType')?.value||'slideLeft';const canvas=document.createElement('canvas');canvas.width=W;canvas.height=H;const ctx=canvas.getContext('2d'),stream=canvas.captureStream(fps),chunks=[];const rec=new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp9',videoBitsPerSecond:8000000});rec.ondataavailable=e=>{if(e.data.size)chunks.push(e.data);};rec.onstop=()=>{const a=document.createElement('a');a.href=URL.createObjectURL(new Blob(chunks,{type:'video/webm'}));a.download=`slideshow-${Date.now()}.webm`;a.click();document.getElementById('progressBar').style.width='100%';document.getElementById('progressText').textContent='Done!';setTimeout(()=>{closeModal('progressModal');toast('Downloaded');},1000);};rec.start(100);document.getElementById('recording').classList.add('active');const fPS=Math.floor(slideDur*fps),fPT=Math.floor(transDur*fps),total=vehicles.length*(fPS+fPT);let frame=0;for(let i=0;i<vehicles.length;i++){const curr=vehicles[i],next=vehicles[(i+1)%vehicles.length];for(let f=0;f<fPS;f++){drawSlide(ctx,curr,W,H,1,i);await new Promise(r=>setTimeout(r,1000/fps));frame++;if(f%5===0){document.getElementById('progressBar').style.width=(40+frame/total*55)+'%';document.getElementById('progressText').textContent='Slide '+(i+1)+'/'+vehicles.length;}}for(let f=0;f<fPT;f++){const t=f/fPT;ctx.clearRect(0,0,W,H);if(transType==='slideLeft'){ctx.save();ctx.translate(-W*t,0);drawSlide(ctx,curr,W,H,1,i);ctx.translate(W,0);drawSlide(ctx,next,W,H,1,i+1);ctx.restore();}else if(transType==='fade'){drawSlide(ctx,curr,W,H,1-t,i);drawSlide(ctx,next,W,H,t,i+1);}else{drawSlide(ctx,next,W,H,1,i+1);}await new Promise(r=>setTimeout(r,1000/fps));frame++;}}document.getElementById('recording').classList.remove('active');rec.stop();}
function downloadSlide(){const canvas=document.getElementById('mainCanvas'),v=vehicles[currentIdx],a=document.createElement('a');a.download=v?`${v.year}-${v.make}-${v.model}.png`:'slide.png';a.href=canvas.toDataURL('image/png');a.click();toast('Exported');}
function showModal(id){document.getElementById(id).classList.add('active');}
function closeModal(id){document.getElementById(id).classList.remove('active');}
function closeAllModals(){document.querySelectorAll('.modal-overlay').forEach(m=>m.classList.remove('active'));}
function toast(msg){const t=document.createElement('div');t.className='toast';t.textContent=msg;document.getElementById('toasts').appendChild(t);setTimeout(()=>t.remove(),3000);}
setTimeout(loadLayouts,500);
</script>
</body>
</html>
